#!/usr/bin/env bash
# Helper script for eddi message server operations

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print colored message
print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Build the project if needed
ensure_built() {
    if [ ! -f "$PROJECT_ROOT/target/debug/eddi" ]; then
        print_info "Building eddi..."
        cd "$PROJECT_ROOT"
        cargo build
    fi
}

# Quick fortress creation
create_fortress() {
    local name="${1:-demo-fortress}"
    local ttl="${2:-5}"

    print_info "Creating fortress: $name"
    print_info "Message TTL: $ttl minutes"

    ensure_built

    cd "$PROJECT_ROOT"
    cargo run --quiet -- msgsrv create-fortress --name "$name" --ttl "$ttl"

    print_success "Fortress '$name' created"
}

# Quick broker creation
create_broker() {
    local fortress="${1:-demo-fortress}"
    local namespace="${2:-user@example.com}"

    print_info "Creating broker for fortress: $fortress"
    print_info "Namespace: $namespace"

    ensure_built

    cd "$PROJECT_ROOT"
    cargo run --quiet -- msgsrv create-broker \
        --fortress "$fortress" \
        --namespace "$namespace"

    print_success "Broker created"
}

# Quick send message
send_message() {
    local msg="$1"
    local server="$2"

    if [ -z "$msg" ]; then
        print_error "Message required"
        echo "Usage: $0 send-message <message> [server]"
        exit 1
    fi

    ensure_built

    cd "$PROJECT_ROOT"
    if [ -n "$server" ]; then
        cargo run --quiet -- msgsrv send --server "$server" "$msg"
    else
        cargo run --quiet -- msgsrv send "$msg"
    fi

    print_success "Message sent"
}

# List all fortresses
list_fortresses() {
    ensure_built

    cd "$PROJECT_ROOT"
    cargo run --quiet -- msgsrv list-fortresses --verbose
}

# Show status
show_status() {
    local name="$1"

    ensure_built

    cd "$PROJECT_ROOT"
    if [ -n "$name" ]; then
        cargo run --quiet -- msgsrv status "$name"
    else
        cargo run --quiet -- msgsrv status
    fi
}

# Cleanup
cleanup() {
    print_warning "This will clean up stopped servers and stale connections"
    read -p "Are you sure? (y/N) " -n 1 -r
    echo

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        ensure_built

        cd "$PROJECT_ROOT"
        cargo run --quiet -- msgsrv cleanup --force

        print_success "Cleanup complete"
    else
        print_info "Cleanup cancelled"
    fi
}

# Show help
show_help() {
    cat << EOF
eddi-msgsrv - Helper script for eddi message server operations

Usage: $0 <command> [arguments]

Commands:
    create-fortress [name] [ttl]    Create a new fortress
                                    Default: name=demo-fortress, ttl=5

    create-broker <fortress> [namespace]
                                    Create a broker for a fortress
                                    Default: namespace=user@example.com

    send-message <message> [server] Send a message

    list                            List all fortresses

    status [name]                   Show status of servers

    cleanup                         Clean up stopped servers (interactive)

    help                            Show this help message

Examples:
    # Create a fortress
    $0 create-fortress my-server 10

    # Create a broker
    $0 create-broker my-server user@example.com

    # Send a message
    $0 send-message "Hello, world!" my-server

    # List all fortresses
    $0 list

    # Show status
    $0 status

    # Cleanup
    $0 cleanup

EOF
}

# Main script
main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        create-fortress)
            create_fortress "$@"
            ;;
        create-broker)
            create_broker "$@"
            ;;
        send-message|send)
            send_message "$@"
            ;;
        list)
            list_fortresses
            ;;
        status)
            show_status "$@"
            ;;
        cleanup)
            cleanup
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "Unknown command: $command"
            echo
            show_help
            exit 1
            ;;
    esac
}

main "$@"
