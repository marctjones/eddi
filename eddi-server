#!/bin/bash
# Simple EDDI Server Launcher
# Usage: ./eddi-server [--force]
#
# Options:
#   --force    Automatically kill existing processes and clean locks

FORCE=0
if [ "$1" = "--force" ] || [ "$1" = "-f" ]; then
    FORCE=1
fi

echo "ğŸš€ Starting EDDI Server..."
echo ""

# Check for running eddi processes
EDDI_PIDS=$(pgrep -f "target/(debug|release)/eddi" 2>/dev/null || true)

if [ -n "$EDDI_PIDS" ]; then
    echo "âš ï¸  Found running eddi process(es): $EDDI_PIDS"

    if [ $FORCE -eq 1 ]; then
        echo "ğŸ”ª Force mode: Killing existing processes..."
        for PID in $EDDI_PIDS; do
            kill -TERM $PID 2>/dev/null || kill -KILL $PID 2>/dev/null || true
        done
        sleep 1
        echo "âœ… Processes killed"
    else
        echo ""
        echo "Another eddi instance is running!"
        echo "Options:"
        echo "  1. Run './eddi-cleanup' to clean up manually"
        echo "  2. Run './eddi-server --force' to auto-cleanup"
        echo "  3. Kill manually: kill $EDDI_PIDS"
        echo ""
        exit 1
    fi
    echo ""
fi

# Clean up Arti locks if they exist
ARTI_DIR="$HOME/.local/share/arti"
if [ -d "$ARTI_DIR" ]; then
    LOCKS_FOUND=0

    # Remove state locks (these are the main culprits)
    if find "$ARTI_DIR" -name "state.lock" 2>/dev/null | grep -q .; then
        if [ $FORCE -eq 1 ]; then
            echo "ğŸ§¹ Removing stale Arti lock files..."
            find "$ARTI_DIR" -name "state.lock" -delete 2>/dev/null || true
            LOCKS_FOUND=1
        else
            echo "âš ï¸  Found Arti lock files"
            echo "Run with --force to auto-cleanup, or use ./eddi-cleanup"
            echo ""
        fi
    fi

    if [ $LOCKS_FOUND -eq 1 ]; then
        echo "âœ… Lock files cleaned"
        echo ""
    fi
fi

# Build if needed
if [ ! -f "target/release/eddi" ]; then
    echo "ğŸ“¦ Building binaries (first time only)..."
    cargo build --release --bins --quiet
    echo "âœ… Build complete"
    echo ""
fi

# Setup Python if needed
if [ ! -d "test-apps/flask-demo/venv" ]; then
    echo "ğŸ Setting up Flask demo (first time only)..."
    cd test-apps/flask-demo
    python3 -m venv venv >/dev/null 2>&1 || true
    if [ -d "venv" ]; then
        source venv/bin/activate
        pip install -q --upgrade pip 2>/dev/null || true
        pip install -q -r requirements.txt 2>/dev/null || true
        deactivate
    fi
    cd ../..
    echo "âœ… Flask setup complete"
    echo ""
fi

# Clean up old socket
rm -f /tmp/eddi.sock

echo "ğŸ”— Bootstrapping to Tor network..."
echo "â³ This takes 30-60 seconds..."
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Run server
exec target/release/eddi
