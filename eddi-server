#!/bin/bash
# EDDI Server Launcher
# Usage: ./eddi-server [OPTIONS]
#
# Launcher Options:
#   --force, -f    Automatically kill existing processes and clean locks
#   --help-launcher Show this help and exit
#
# All other options are passed directly to the eddi binary.
# Run './eddi-server --help' to see eddi binary options.

# Parse launcher-specific arguments
FORCE=0
SHOW_LAUNCHER_HELP=0
EDDI_ARGS=()

while [[ $# -gt 0 ]]; do
    case $1 in
        --force|-f)
            FORCE=1
            shift
            ;;
        --help-launcher)
            SHOW_LAUNCHER_HELP=1
            shift
            ;;
        *)
            # Pass all other arguments to eddi binary
            EDDI_ARGS+=("$1")
            shift
            ;;
    esac
done

if [ $SHOW_LAUNCHER_HELP -eq 1 ]; then
    cat << 'EOF'
EDDI Server Launcher

This script handles:
  - Building the eddi binary (if needed)
  - Setting up Python/Flask demo (if needed)
  - Cleaning up stale processes and locks
  - Launching the eddi server

Launcher Options:
  --force, -f         Automatically kill existing processes and clean locks
  --help-launcher     Show this help and exit

All other options are passed to the eddi binary.

Common eddi binary options:
  --socket, -s PATH           Unix socket path (default: /tmp/eddi.sock)
  --nickname, -n NAME         Onion service nickname (default: eddi-demo)
  --app-dir, -d PATH          Web application directory
  --app-module, -m MODULE     WSGI module (default: app:app)
  --workers, -w NUM           Number of workers (default: 2)
  --no-spawn                  Don't spawn app (assume it's running)
  --help                      Show full eddi binary help

Examples:
  ./eddi-server
    Start with default settings (spawns Flask demo)

  ./eddi-server --nickname my-blog --socket /tmp/blog.sock
    Start with custom nickname and socket path

  ./eddi-server --no-spawn --socket /var/run/myapp.sock
    Connect to existing app on custom socket

  ./eddi-server --force --nickname test --workers 4
    Force cleanup, custom nickname, 4 workers

For full eddi binary documentation, run: ./eddi-server --help
EOF
    exit 0
fi

echo "ğŸš€ Starting EDDI Server..."
echo ""

# Check for running eddi processes
EDDI_PIDS=$(pgrep -f "target/(debug|release)/eddi" 2>/dev/null || true)

if [ -n "$EDDI_PIDS" ]; then
    echo "âš ï¸  Found running eddi process(es): $EDDI_PIDS"

    if [ $FORCE -eq 1 ]; then
        echo "ğŸ”ª Force mode: Killing existing processes..."
        for PID in $EDDI_PIDS; do
            kill -TERM $PID 2>/dev/null || kill -KILL $PID 2>/dev/null || true
        done
        sleep 1
        echo "âœ… Processes killed"
    else
        echo ""
        echo "Another eddi instance is running!"
        echo "Options:"
        echo "  1. Run './eddi-cleanup' to clean up manually"
        echo "  2. Run './eddi-server --force' to auto-cleanup"
        echo "  3. Kill manually: kill $EDDI_PIDS"
        echo ""
        exit 1
    fi
    echo ""
fi

# Clean up Arti locks if they exist
ARTI_DIR="$HOME/.local/share/arti"
if [ -d "$ARTI_DIR" ]; then
    LOCKS_FOUND=0

    # Remove state locks (these are the main culprits)
    if find "$ARTI_DIR" -name "state.lock" 2>/dev/null | grep -q .; then
        if [ $FORCE -eq 1 ]; then
            echo "ğŸ§¹ Removing stale Arti lock files..."
            find "$ARTI_DIR" -name "state.lock" -delete 2>/dev/null || true
            LOCKS_FOUND=1
        else
            echo "âš ï¸  Found Arti lock files"
            echo "Run with --force to auto-cleanup, or use ./eddi-cleanup"
            echo ""
        fi
    fi

    if [ $LOCKS_FOUND -eq 1 ]; then
        echo "âœ… Lock files cleaned"
        echo ""
    fi
fi

# Build if needed
if [ ! -f "target/release/eddi" ]; then
    echo "ğŸ“¦ Building binaries (first time only)..."
    cargo build --release --bins --quiet
    echo "âœ… Build complete"
    echo ""
fi

# Setup Python if needed
if [ ! -d "test-apps/flask-demo/venv" ]; then
    echo "ğŸ Setting up Flask demo (first time only)..."
    cd test-apps/flask-demo
    python3 -m venv venv >/dev/null 2>&1 || true
    if [ -d "venv" ]; then
        source venv/bin/activate
        pip install -q --upgrade pip 2>/dev/null || true
        pip install -q -r requirements.txt 2>/dev/null || true
        deactivate
    fi
    cd ../..
    echo "âœ… Flask setup complete"
    echo ""
fi

# Extract socket path from arguments (if provided)
SOCKET_PATH="/tmp/eddi.sock"
for i in "${!EDDI_ARGS[@]}"; do
    if [ "${EDDI_ARGS[$i]}" = "--socket" ] || [ "${EDDI_ARGS[$i]}" = "-s" ]; then
        if [ $((i + 1)) -lt ${#EDDI_ARGS[@]} ]; then
            SOCKET_PATH="${EDDI_ARGS[$((i + 1))]}"
        fi
    fi
done

# Clean up old socket if it exists
if [ -e "$SOCKET_PATH" ]; then
    echo "ğŸ§¹ Removing old socket: $SOCKET_PATH"
    rm -f "$SOCKET_PATH"
    echo ""
fi

echo "ğŸ”— Bootstrapping to Tor network..."
echo "â³ This takes 30-60 seconds..."
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Run server with arguments
if [ ${#EDDI_ARGS[@]} -eq 0 ]; then
    # No arguments - use default (spawn Flask demo)
    exec target/release/eddi --app-dir test-apps/flask-demo
else
    # Pass through user arguments
    exec target/release/eddi "${EDDI_ARGS[@]}"
fi
