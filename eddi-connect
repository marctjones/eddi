#!/bin/bash
# EDDI Tor Client - Connect to any URL via Tor
# Supports both Tor hidden services (.onion) and regular websites (via Tor exit)
# Usage: ./eddi-connect <url> [OPTIONS]
#
# Run ./eddi-connect --help to see all available options.

set -e

# Check if help is requested
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    if [ ! -f "target/release/tor-http-client" ]; then
        echo "ğŸ“¦ Building client to show help..."
        cargo build --release --bin tor-http-client --quiet
        echo ""
    fi
    exec target/release/tor-http-client --help
fi

echo "ğŸŒ EDDI Tor Client"
echo ""

# Build if needed
if [ ! -f "target/release/tor-http-client" ]; then
    echo "ğŸ“¦ Building client (first time only)..."
    cargo build --release --bin tor-http-client --quiet
    echo "âœ… Build complete"
    echo ""
fi

# Check if we have arguments
if [ $# -eq 0 ]; then
    # No arguments - try saved address
    if [ -f ".onion_address" ]; then
        URL=$(cat .onion_address)
        echo "ğŸ“ Using saved address: $URL"
        echo ""
        echo "ğŸ”— Connecting to: $URL"
        echo "â³ First connection may take 10-30 seconds..."
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        exec target/release/tor-http-client "$URL"
    else
        echo "âŒ No URL provided"
        echo ""
        echo "Usage:"
        echo "  ./eddi-connect <url> [OPTIONS]"
        echo ""
        echo "Examples:"
        echo "  Tor Hidden Services (.onion):"
        echo "    ./eddi-connect http://example.onion"
        echo "    ./eddi-connect example.onion/status"
        echo "    ./eddi-connect http://example.onion:8080/api"
        echo ""
        echo "  Regular Websites (via Tor anonymously):"
        echo "    ./eddi-connect https://check.torproject.org"
        echo "    ./eddi-connect http://httpbin.org/ip"
        echo "    ./eddi-connect https://www.eff.org"
        echo ""
        echo "Options:"
        echo "  -q, --quiet          Quiet mode - only show response"
        echo "  -v, --verbose        Verbose output"
        echo "  -H, --headers-only   Show only headers"
        echo "  -t, --timeout SECS   Connection timeout (default: 30)"
        echo "  -l, --max-body-size  Max response size in bytes"
        echo ""
        echo "Run './eddi-connect --help' for full help"
        echo "Or start the EDDI server first with: ./eddi-server"
        exit 1
    fi
fi

# Extract URL (first non-option argument)
URL=""
for arg in "$@"; do
    if [[ ! "$arg" =~ ^- ]]; then
        URL="$arg"
        break
    fi
done

if [ -n "$URL" ]; then
    echo "ğŸ”— Connecting to: $URL"
    echo "â³ First connection may take 10-30 seconds..."
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
fi

# Connect via Tor - pass all arguments through
# The tor-http-client handles all URL formats automatically:
# - .onion addresses: direct connection within Tor network
# - Regular URLs: anonymized connection via Tor exit nodes
exec target/release/tor-http-client "$@"
